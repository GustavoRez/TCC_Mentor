<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="/global.css">
    <link rel="stylesheet" href="/projeto.css">
    <title>
 <%= projeto %>    </title>
</head>

<body>

    <header class="top-bar">
        <a href="/home" class="voltar">
            &#x2190; <!-- seta para esquerda -->
        </a>
    </header>

    <section class="detalhes">
        <div class="descricao">
            <h1 class="titulo-projeto">
                <%= projeto %>
            </h1>
            <p><strong>DescriÃ§Ã£o:</strong><br>
                <%= desc %>
            </p>
            <p><strong>Tipo:</strong>
                <%= tipo %>
            </p>
            <p><strong>Integrantes:</strong><br>
                <%= aluno %>
            </p>
            <p><strong>Orientador:</strong><br>
                <%= orientador %>
            </p>
        </div>
    </section>

    <section id="chat">
        <% mensagens.forEach(msg=> { %>
            <div class="mensagem">
                <h2>
                    <%= msg.mensagem %>
                        <% if (msg.remetente=='ORIE' ) { %>
                            <button class="analisar-btn" onclick="this, '<%= msg.mensagem %>'">Analisar</button>
                            <% } %>
                </h2>
                <h4>
                    <%= msg.data_envio %>
                </h4>
                <h4>
                    <%= msg.remetente %>
                </h4>
            </div>
            <% }) %>
    </section>

    <form id="formMensagem" enctype="multipart/form-data">
        <input type="text" name="mensagem" id="msg" placeholder="Digite sua mensagem...">
        <input type="file" id="pdf" name="arquivo_pdf" accept=".pdf">
        <button type="submit">Enviar</button>
    </form>

    <div id="chat-button" onclick="toggleChat()">ðŸ’¬</div>

    <div id="chat-window">
        <div id="chat-header">
            Chat com Tessy *(chat temporÃ¡rio)*
            <span onclick="toggleChat()">âœ–</span>
        </div>
        <div id="chat-body">

        </div>
        <div id="chat-input">
            <form id="msgChat" enctype="multipart/form-data">
                <div class="mensagem-junto">
                    <input type="text" name="mensagem" class="mensagem" id="msg_chat"
                        placeholder="Digite sua mensagem..." autocomplete="off">
                    <button class="seta" type="submit">â­¡</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const idProjeto = '<%=idProjeto %>';

        document.getElementById('formMensagem').addEventListener('submit', function (e) {
            e.preventDefault();

            const inputTexto = document.getElementById('msg');
            const arquivo = document.querySelector('input[type="file"]').files[0];
            const texto = inputTexto.value.trim();

            if (!texto && !arquivo) {
                alert("Digite uma mensagem ou selecione um arquivo PDF.");
                return;
            }

            const formData = new FormData(this);
            formData.append('idProjeto', idProjeto);
            formData.append('remetente', '<%=cargo%>');

            fetch('/mensagens', {
                method: 'POST',
                body: formData
            }).then(() => {
                document.getElementById('msg').value = '';
                document.getElementById('pdf').value = '';
                buscarMensagens();
            }).catch(err => console.error('Erro ao enviar:', err));
        });

        function buscarMensagens() {
            const cargo = '<%= cargo %>'
            fetch(`/mensagens?idProjeto=${idProjeto}`)
                .then(res => res.json())
                .then(data => {
                    const chat = document.getElementById('chat');
                    chat.innerHTML = '';

                    data.forEach(msg => {
                        chat.innerHTML += `
                    <div class="mensagem">
                        ${msg.mensagem ? `<h2>${msg.mensagem}  ${cargo === 'ALUN' ? `${msg.remetente === 'ORIE' ? `<button onclick="analisaMsg(this, '${msg.mensagem}')">Analisar</button>` : ''}` : ''}</h2>` : ''}
                        ${msg.arquivo_pdf ? `<a href="/uploads/${msg.arquivo_pdf}" target="_blank">ðŸ“Ž Ver PDF</a>` : ''}
                        <h4>${msg.data_envio}</h4>
                        <h4>${msg.remetente}</h4>
                    </div>
                `;
                    });
                });
        }

        setInterval(buscarMensagens, 2000);
        buscarMensagens();

        function toggleChat() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.style.display = chatWindow.style.display === 'none' || chatWindow.style.display === '' ? 'flex' : 'none';
        }

        document.getElementById('msgChat').addEventListener('submit', async function (e) {
            e.preventDefault();

            const idProjeto = "<%=idProjeto%>"
            const msg = document.getElementById('msg_chat').value;
            const chatBody = document.getElementById('chat-body');
            if (msg === '') return;

            const userMsg = document.createElement('div');
            userMsg.textContent = `VocÃª: ${msg}`;
            chatBody.appendChild(userMsg);


            if (!msg) {
                alert("Digite uma mensagem.");
                return;
            }

            resposta = await fetch('/chatbox', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ msg, idProjeto })
            })

            document.getElementById('msg_chat').value = '';
            chatBody.scrollTop = chatBody.scrollHeight;

            const dados = await resposta.json();
            const iaMsg = document.createElement('div');
            iaMsg.textContent = `IA: ${dados.resposta}`;
            chatBody.appendChild(iaMsg);
        });

        function analisaMsg(btn, msg) {
            btn.disabled = true;
            btn.textContent = 'Analisando...';

            fetch('/analisaMsg', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ msg, idProjeto })
            })
                .then(response => response.json())
        }
    </script>
</body>

</html>