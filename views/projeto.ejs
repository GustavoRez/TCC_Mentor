<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.png" type="image/png">
    <title>
        <%=projeto%>
    </title>
    <style>
        #chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #0084ff;
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
        }

        #chat-window {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 999;
        }

        #chat-header {
            background: #0084ff;
            color: white;
            padding: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-body {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-size: 14px;
        }

        #chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ccc;
        }

        #chat-input input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #chat-input button {
            margin-left: 5px;
            padding: 5px 10px;
        }
    </style>
</head>

<body>
    <a href="/home"><button>
            <p>Voltar</p>
        </button></a>
    <h1>
        <%=projeto%>
    </h1>
    <p>
        <%=desc%>
    </p>
    <p>
        <%=tipo%>
    </p>
    <p>
        <%=orientador%>
    </p>
    <p>
        <%=aluno%>
    </p>
    <div id="chat">
        <% mensagens.forEach(msg=> { %>
            <div class="mensagem">
                <h2>
                    <%= msg.mensagem %>
                </h2>
                <h4>
                    <%= msg.data_envio %>
                </h4>
                <h4>
                    <%= msg.remetente %>
                </h4>
            </div>
            <% }) %>
    </div>

    <form id="formMensagem" enctype="multipart/form-data">
        <input type="text" name="mensagem" id="msg" placeholder="Digite sua mensagem...">
        <input type="file" id="pdf" name="arquivo_pdf" accept=".pdf">
        <button type="submit">Enviar</button>
    </form>

    <div id="chat-button" onclick="toggleChat()">
        ðŸ’¬
    </div>

    <div id="chat-window">
        <div id="chat-header">
            Chat com Tessy *(chat temporÃ¡rio)*
            <span onclick="toggleChat()">âœ–</span>
        </div>
        <div id="chat-body">
        </div>
        <div id="chat-input">
            <form id="msgChat" enctype="multipart/form-data">
                <input type="text" name="mensagem" id="msg_chat" placeholder="Digite sua mensagem..." autocomplete="off">
                <button type="submit">Enviar</button>
            </form>
        </div>
    </div>

    <script>
        const idProjeto = '<%=idProjeto %>';

        document.getElementById('formMensagem').addEventListener('submit', function (e) {
            e.preventDefault();

            const inputTexto = document.getElementById('msg');
            const arquivo = document.querySelector('input[type="file"]').files[0];
            const texto = inputTexto.value.trim();

            if (!texto && !arquivo) {
                alert("Digite uma mensagem ou selecione um arquivo PDF.");
                return;
            }

            const formData = new FormData(this);
            formData.append('idProjeto', idProjeto);
            formData.append('remetente', '<%=cargo%>');

            fetch('/mensagens', {
                method: 'POST',
                body: formData
            }).then(() => {
                document.getElementById('msg').value = '';
                document.getElementById('pdf').value = '';
                buscarMensagens();
            }).catch(err => console.error('Erro ao enviar:', err));
        });

        function buscarMensagens() {
            fetch(`/mensagens?idProjeto=${idProjeto}`)
                .then(res => res.json())
                .then(data => {
                    const chat = document.getElementById('chat');
                    chat.innerHTML = '';

                    data.forEach(msg => {
                        chat.innerHTML += `
                    <div class="mensagem">
                        ${msg.mensagem ? `<h2>${msg.mensagem}</h2>` : ''}
                        ${msg.arquivo_pdf ? `<a href="/uploads/${msg.arquivo_pdf}" target="_blank">ðŸ“Ž Ver PDF</a>` : ''}
                        <h4>${msg.data_envio}</h4>
                        <h4>${msg.remetente}</h4>
                    </div>
                `;
                    });
                });
        }

        setInterval(buscarMensagens, 2000);
        buscarMensagens();

        function toggleChat() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.style.display = chatWindow.style.display === 'none' || chatWindow.style.display === '' ? 'flex' : 'none';
        }

        document.getElementById('msgChat').addEventListener('submit', async function (e) {
            e.preventDefault();

            const idProjeto = "<%=idProjeto%>"
            const msg = document.getElementById('msg_chat').value;
            const chatBody = document.getElementById('chat-body');
            if (msg === '') return;

            const userMsg = document.createElement('div');
            userMsg.textContent = `VocÃª: ${msg}`;
            chatBody.appendChild(userMsg);


            if (!msg) {
                alert("Digite uma mensagem.");
                return;
            }

            resposta = await fetch('/chatbox', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ msg, idProjeto })
            })

            document.getElementById('msg_chat').value = '';
            chatBody.scrollTop = chatBody.scrollHeight;

            const dados = await resposta.json();
            const iaMsg = document.createElement('div');
            iaMsg.textContent = `IA: ${dados.resposta}`;
            chatBody.appendChild(iaMsg);


        });
    </script>
</body>

</html>